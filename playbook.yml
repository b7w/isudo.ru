---
- name: Build and push docker image
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    conf_py: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      63323130363731373331353961623832343638646164363033666161643531313262623765356162
      3761663639313465396432633636396538646533313933660a336337643066653166636166393939
      35386262383530623663663737396531633564373462376366666535393635313066343165303739
      3962313536313833640a633238346632383938633434363761363236326166643031623332333062
      35303937646138643661393133363639343331333431343236326538353732313131373135663530
      61353134313861363130636466643436303736633336323631383031646639656337653435623439
      36636233633532393235653532316530623134333930343034356636333439353362383665646166
      30303061323535613331613637623538323565383066383030386531323362663932656261663139
      37353061656331633033336366656633656330623836323038663130656331363934396437323038
      38356236613066666433303666623364663634386333636566653461376333633735376439366139
      65396262393331356562393766663233633038633431376663623865643931633535346435346539
      32366163376233343663303334333761636566326330313661343037666534333130313665373466
      30313363643635623733346435346533616334663661383636343130353936353633353562626366
      31326339323766633138356331653161636364636230643433656536373737333530626463636135
      65626137613138376530393464316362396330646166643035336331356165313834316462396337
      37303737316336303163363866333264333865633730653162376265333532316263366262623733
      37633837616165393132653131393561306334393464316538356339643535633939643461313232
      32323339626431633137656432616163303432363463626235373932333132383139396263346566
      35373438306537623061663566376339643539303962663438363266656439663538303539303464
      38623631333837366432643932636437353262353338383566633432653362303938623161623663
      31306465616331306231343465626136373064386564653438663065646432323131393063373337
      38633830653965633631393361333036643533363938653535626238306636386263343330346364
      35303565626138376330643336366433333836326430313231613332336433343636653732623635
      66643665613535663639616138633264623063346135363833633033343937386136663431323337
      33316433343336633965663761346462383265343631323230366263316665333334386566306535
      30633565333766656333316266333533303264663435646432663363333664623364316636323961
      61383265383637303363656534613930633066393035656363656266646466303964313130363334
      64346633376433346262316339646161356662353535303332303531633739623533353633383833
      30303764356536323063343335376136623761616364326661656331633734366261323136313063
      35616462623232616466383139333365386337376333616637646331393039333630623437343937
      61356132653135356631303430623062643462646536313533656133373737383861306234653736
      37666536656464336234383463323130326362363665623630646163646565323330626531636230
      37376235633162396162643563363439313930643930326635343563386637383262663761633366
      35613633663830333863363266383630343930343034386164616637623938333035616634633736
      66663963373964316266333733343637333166663836326431643263353439386439303730366461
      31656338643133356239363663373361663030643732613331336135356135663939656164643235
      33373931323166343032626364373834613538373466626239386332623664613337643032626430
      38376235353332323735336365353130363861616438376435313533326335663734303033393734
      66346337336439616537666330386666363535316264623338666462323732353362316639653530
      30643266333839333338353638646265626263653334663331333865623563646565343063636566
      66616139396436313863306664376633636134373166373362373334343236646562353465396433
      64306336643830366463613062613939356538346639646466303663303533343462323466303766
      33393736386235376666363834343735383632343132343864326134643033316433633830613838
      63313161623263343566356136613035656135333430626164386330313834613139316430333561
      63616535313265306663383164323932333165653132343235613531623938366461306636366331
      64303438636531376435313833306538313232346330653834353966613665623139656637613964
      65623532663034633866636236636539313166323163616265313137623737373139623564656539
      65366138363038623830303132653465656666396465386534333137636431326137376434613033
      36366330653732343565343735643834653834363239323963306263396165613136636162326537
      66356333323135303631333537316563613339383465373133373966653031616636383564373033
      63346639663831313735663864663032376361303038663936383830633663643431316564373630
      34366366303530656530313036666366316239303930643162353736373036326534376637323738
      66346634663835326264626133383930336636346439633834313533646134363630383761323661
      63623665373066653336343365646261623937383630663961386463633763303764656435383830
      36396662323637396630363662663535363531653764366136383435653931363861303637303366
      30616430633963636333306337663363373933633436613165326662663736613534366433633633
      30376438303931386562633266346633656561316639376333346164396666336466643635366133
      33363664306366656138653362653063643438646362633833363630393364393338386137353536
      36373130623437373430323464333333343231343866303434313566323638623338383237336231
      30613335633961353339343433613633393464353232643531306432353861616130613863333931
      38316239316138346633333933336263373834616139643738343565343633663661613139373361
      63393137343035626335656536663636663230646138376532336130626165353935646531383831
      64346331396134346534633332323036326532303936333132613261646564323538333034333236
      36386665303664396132613732396464363632356363316430613434356263396238393533373936
      62326333356161353132656336356139656663393263366630653066633862303134623337663534
      32356561393566653862353734316630386531323363386137383434376662373461306334376633
      66366232393935323737373039656165323936613236333634376332633332623965616166626330
      32353130663063636339353562653866343265353563313731326661613239386537636261653864
      66373935303932303430393938353637616436653535383438323531643736643739666633383733
      66323262393132303662623931363335653134626235643730323839646561316463623738623262
      35616164303936633665663664376137303736363662626633373861313161333465306136303961
      30356332623435386666316664663037303732663833376464333830396162343730646333373462
      37613664303535363830343530353933393062623565363364363538626533643833346436643066
      64363066393864666431373239613239613239326533656666396232623030346461396437326265
      61323631663365663465366638333639346266643133343633383664396331366336316535653364
      37303835393063613264643466333463396637656138653464383038663536313036313865356164
      31333735613136646261346663666330366664636531663233653635313732656466383935656333
      37343036663232383638373365373532303833663138313266613936666339336365613532666330
      31363464393931393738353337316535626365666465323637303630313139613134666531366463
      33636664343362623937653936303135303762656266643531643839653536313963333030326537
      3631
    aws_region: 'eu-central-1'
    aws_access_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      35366133633063353231396665623265333033383238396435613366643465383062623866643334
      3362333934643764643234643261613263356461356530660a303437643134646531663262313366
      61626639616538373762366162343133613039636537303964363361346261376431356537623533
      6163396233663534610a343763646239363362656666653931393239316437636362613166303438
      36643665313536333834303966663633346262306166643166393339646132343866
    aws_secret_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      63343363653132613038316332313035373536663261663034313130326635636331613061316639
      3430316633333337613737383565333736313762366565330a383735323662383561306664326566
      39333731316362366266656263383861313337313835336234306165386131363964656634313538
      6166313435303339610a326531626163316335343233663664373861616565393231643230383832
      64396132346562366362366230636461393762323635326430383163303030353061313264386530
      6331656134353062373662623331643632383730336634373333
  tasks:
    - name: Write config
      copy:
        content: '{{ conf_py }}'
        dest: 'conf.py'

    - name: Create aws directory
      file:
        path: '.aws'
        state: directory
        mode: '0755'

    - name: Write aws config
      copy:
        content: |
          [default]
          region={{ aws_region }}
        dest: '.aws/config'
        mode: '0600'
        force: no

    - name: Write aws credentials
      copy:
        content: |
          [default]
          aws_access_key_id={{ aws_access_key }}
          aws_secret_access_key={{ aws_secret_key }}
        dest: '.aws/credentials'
        mode: '0600'
        force: no
