---
- name: Build and push docker image
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    conf_py: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      31353330636265353764656164653037303862303865643466626235663031663565333963643664
      3762333436383038386433633737376661303761663961610a643762666366383635363864643437
      66393532303565386332383533383932613034643431363932636262643664633835396432633437
      6237643163346162360a373961666430366639623533353135396337306433343263643532383735
      33386139646461663230396130363765313861653664343764396338383362613936643131323863
      35383631333639383838613165386164376339636265323132613366383739366464626132383530
      30666362326633313362646434366133643163663937393331616434623765323561323239653838
      64313733646464363335663539303935393335633334623730373537633039356631326236663630
      35323637306636343663343663663831356537613964646633623965326530626334313830363636
      66313261613236636662336463356361313030623463666434373330323034613061343936376138
      38313562616233366136393732613238613831626261323633643762633336393166366433666434
      66333363626265346533343536353638643166316161303235316230396262313862663266326162
      38396535333064366538333635643337633532373364623436323337336435343636363637316632
      32373134373031303139316164303161313263363839353536363066373965313832613835633433
      30353530356430306432323464656633343264333366656138613831663132636633346536303464
      64316235623331623037663130643166613063313935323734303433366531613330333438653464
      62626665373430663065353739363935613466623166363263383461383138653965663062366435
      66613337646433316536333263616332303037396365366131373065396232303738366339633131
      34396232393065336166363866396638316237346135323837353039373234393939643961613365
      37326639333565386539316132633735643430363164353732316565313832343535323733643863
      63616634373464323964326533373832303966313161376665333462303764313363303430396432
      38303465623337326637336461396236393633353330623636343639356161323231346633393435
      30376263393665373962393935623638343263623130366433663739373364643938633036376466
      39343437323866633265336264643663623365323737353533613435623464613536336239366430
      63646135396533636431346135393531656564303232643666366634623230666266386137653138
      65326130333635653564663237353164333836346266333933643036373331383834366231386337
      62623465343138656361363636613165646634323063663333373237356437636466616532666534
      35306138663963303132616161616262376162306465346334663835333061653364363931663065
      30636365613036363031666635353966623138376636623363356531316135616162303765346330
      38303433646466613731353066386562353364626633666434633364373131323531653533623434
      64366636346562353634376135343535356433383561623239663636393563346232396239303739
      39646166313331346261633933663934623564346537336466346134343736393632343363333665
      66373863303732626635313636383835663562613864616535663833366134336364373166393466
      66363165366239376534663833393062303738363630393333633336613433626632613037343531
      38323332363730393236366361336137653638346562386539366663626266323038393133356335
      66633234643137316638316232643136373735363936323035636638326633356532333562613236
      36363462343531363138633461653764353733353164663430326161656631396432633437396330
      39383063343565363663613635353637393339336264376630326230633633663166633534376133
      62663339643665356132656263363361303030326332373633623464623634653361393938653038
      35363263626130613566353465656536363163656336306464313431303832613030656138626561
      65303963666139636539643635633537366536393337653164386561333034653131366261396361
      66623035666132373033383064323934343237343665643837396230316239383362323166356232
      63613139653130396131336462343037373830376163306339633937346235393236616233633164
      62383530383638303066613036383735363836383065653363303035383561393936616133356136
      34613764363632323737376137663563363831376639663863653563393665303737663439393836
      35643939363238303462663131663962383134373330353232373330623136656632643932393638
      33646136373133343535633164623162373665393264326339643235363231396562653330333661
      62313834656139633465353266333065393339623361343235313531393332646635623463363939
      36366636636466316364623865333132363538633438323033303333333163313238303763373365
      37633635656337376431643037363533316438643836313732663930336130363031346332623066
      63363537316639626337353038383830373631363231323034636530346537323134623432313864
      30326439346239306531393966356339376261323466346439633365376632613938623136353666
      36343865343538343734653964613664313665386263373233653864623663313734643965323165
      63633866383938613564333332643766633236656535353932316566643864366537626165626138
      38393833306534636138343563613465643030636563333565613335373165333730386239373137
      31393334616432646537653737363330386235366633613233383133336563356366613931333833
      35396161626339636432346534316639316535333334336638363732356662623335333636393563
      31643265333861616666643233336637666263323132363361633562356433666262366536633164
      34376366373066656638623733373637633863323165376266623731333066323566363061336530
      32356363313964663765396334363461393739653635323463336230646564313838386339343536
      39393034663065363132393733366231646233643331346663383536313734653739383935326239
      37646634396533623139346534323032666430353134316230363237393762613233346233303364
      65646231303930376561373737646365336562323737633932303264373833653564326666356638
      64356636633733623032666464306234356331663431316362663563363132326365373739646433
      64313639646263306166343636646364633537383337656231663364643232613237363066623365
      66386439653032303738613335313038666637646162343562396334303266643238333634313036
      35623064366535653630333339636337333061663035633565386630346239646565356662356337
      35633938323165636562323936643566663762313738353264303366623834313937616137663935
      33383031313663343734353933313065303937633334656434313065396164346666386638346436
      37623232663332613763333566616261613631646263303832393935613039306566303538386263
      30366664373362323761333636643531366261653136353463323462353033373361386366383466
      33326333353732366230633633613434303832326164386265343163353132343561366335343261
      35366464653235663434623130363730336662356630643239376632616432386162653633363661
      35356165363337623366346339353763636435333035383130306135316539613737383339633732
      66373363633863616639393862326666653230653433633237323731393364346438353362353231
      61323336613830653235613232376136636266303862303230353431343736313335613364376431
      65383133323864343536376165623332616631313536666462393264616333316461313165646230
      34316639613231316532343935366237346136623233346235323466343035336262373631363934
      38613462343762373764613235633132323034316462316562616231346338613163626662306534
      62653434383564313032653032323134333362376334633835653764336365333061353164653935
      38353239636336623636303563376634333834626362353638376336353435666466353536666137
      34663662663264316337356130356664353339386334653339323336613332373462616130653765
      66396161363730306239633037343235386539356163386663613330616634313961613562343531
      66356131623263373164646639343738306536626335356337343161356364366137326365326364
      62306138383938386232323735353239356432303135623637366537363134316135386462393531
      64666634363235356566353364313865323837653238636636396565393333326339663062663134
      61373238356135653562336264313661656235393965393436616533313366616430663438343337
      35356261643434343734626432376134643233663263303563613633323837616635363232323862
      31383062353031383934633763356132386262396665396130316233656463396335373539363433
      62656463646639623730386464656230333064383562666463666564636332613963363163333664
      33623561333264613366333538613131343837363661313865313030633966643532376136656138
      63633964353730383038643134653834663661373665353335613164386561303164626530663063
      34306639633738396464653432336564366533646363393561376631313333636236646164656535
      63646637363933386164386566663166363733633064653537316532623465343264646531623939
      32636233663364656362333830353138326137373734316462653934383235616236656334383939
      32333834303063393537326266356130363932336530633966376662646137346334363836653638
      64336366356236623832313334633530303065663030363366646332393561326430333731366164
      32373564353430383631326439623439313165346531346366343762323037373061616339376238
      36653839333539386230613035323933343531633431613235643366366662386461393436656361
      36616637323132613433343635303331303764636161663863313236383062646564336361326237
      35366335393361323832616466386130333261396231643262636439346363643962626337323033
      3433323731333631663233343439366639303932346331646366
    aws_region: 'eu-central-1'
    aws_access_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      35366133633063353231396665623265333033383238396435613366643465383062623866643334
      3362333934643764643234643261613263356461356530660a303437643134646531663262313366
      61626639616538373762366162343133613039636537303964363361346261376431356537623533
      6163396233663534610a343763646239363362656666653931393239316437636362613166303438
      36643665313536333834303966663633346262306166643166393339646132343866
    aws_secret_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      63343363653132613038316332313035373536663261663034313130326635636331613061316639
      3430316633333337613737383565333736313762366565330a383735323662383561306664326566
      39333731316362366266656263383861313337313835336234306165386131363964656634313538
      6166313435303339610a326531626163316335343233663664373861616565393231643230383832
      64396132346562366362366230636461393762323635326430383163303030353061313264386530
      6331656134353062373662623331643632383730336634373333
  tasks:
    - name: Write config
      copy:
        content: '{{ conf_py }}'
        dest: 'conf.py'

    - name: Create aws directory
      file:
        path: '~/.aws'
        state: directory
        mode: '0755'

    - name: Write aws config
      copy:
        content: |
          [default]
          region={{ aws_region }}
        dest: '~/.aws/config'
        mode: '0600'
        force: no

    - name: Write aws credentials
      copy:
        content: |
          [default]
          aws_access_key_id={{ aws_access_key }}
          aws_secret_access_key={{ aws_secret_key }}
        dest: '~/.aws/credentials'
        mode: '0600'
        force: no
