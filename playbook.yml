---
- name: Build and push docker image
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    conf_py: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      38366165306665333633313464613034333465396234313631336439386362373736383939343632
      3564623636393032643832346261616131623263346561660a653134386362613739333064613531
      31303239653863356330363966313736633362326165333462653937613836343437396135386230
      3130363363383233660a613231376163393238306635353734316537376566363565383762303936
      35376132373330623737326333356665316632316236393731636165643234346432336432623839
      34656261363230373465343565666237323333303835376665613663663766633637333162376531
      38636434393633616466353766666665653233333530656434653633343462646631336436616330
      35303732363635626333326638383337613134653036396130343663373765393736656334303962
      31643439646239623333303632376638353063316162343239663064653939333231373137393238
      32646461323639663232383930663938373536326263313061326636323861386130383065633739
      62616561383935313366383537333738313661663562356639326361653837313331643438663332
      32613463666266346163666463366439306566366131316437623463616336346638653139356436
      64623631396532356535643939396562316266343963653135333836383538313631326339333739
      39313562626237373435363233313533333861663237326431373532353065613234313338366432
      35663432353066623863353866303436633137313963626331653762373165623633636366646562
      64393866353337346436323966656162663735396364306262643065666465616330663335653365
      65636236623535396363616639363030396233663466376535616261313236333035326634383464
      35363664653436613666623236663561343531306537336262316561313337313733653339333237
      65303964656665373133616132343333616562316164653431373064656235356464376236343036
      66386337343362393834613163363338613631623732316263343762353930633234346432323863
      38653666653566633661366436346362313163616665313163396461653832643435313861326134
      66643834323662636264626263306531336535663035653461646465623763613635343430313434
      34316566306233636166636265396562353836363131656534363534663639613233653335376430
      32636132393937356462303931626433346264616666343634623233363835306365613438663861
      36336635656336313832303364666565356139653066346336613663373761626538356538653862
      37346563363765383132636362333535363563363966303330663437363261643935303063346464
      30636565313665353939393761623637343235313466323363383338303862646435343065366666
      61353939393962386666653032306431346536313763316637386562386235313932663636633033
      35396661653262633033356337303861373833373366653761623631643834353963323738316232
      39643264363161343832623064663732653230373763663531636161663762396564633261653865
      65323761353331333532386230323238663262663236663835363163333930653163363237393437
      32303038326237376463313463343834373134373062306637383937663534313265356638323366
      62343831306166303763313764636535636365376236386539353431643363613066633930396364
      35653162383862653731346230373937376633666334623463353732386334383937393635663265
      63626666666136343066343261343334643733346165633733633233353833316636373839653734
      36353931646532363466306266663235623666366439633134363736323761623035613038353034
      66646264373639353132646466653263633838633039623039333764383734366366376637663130
      33303831383561356564633636376537653061633230363465393365396233363234356164356265
      32373362666534346538613032633230643661633435356131656138656531313434303234363563
      33303230326230383638316463356131386633373239316330326162613336303336356137653663
      31613636373366653961653637366364393637353239343561343237663733633932353633316566
      38636561353630643363653266623436313162656661663466623161633139653632646438613366
      31643433333132653034633539343163343162666563366430363734623630326430633930363062
      62626566303261383434323832336461363538333535633061393235353239653361616536636632
      35303665346232623263343233656566356562353365343862326339636535323437363135616538
      33346365643334663761643631663361396266376163623134356339313037356237376365333239
      38666433626234373337663463356432303935346365373535666530393834633662393561356534
      34643330356364626565653866646138653939613732343338323739376461313632343163323336
      63393162393738386334646632366434663635333333343334366235323162346364626163653338
      61313331663535613134366236323733623030653566363732313236376230666632646532613733
      36363166353130396533666666376632376232333065346466616661343466313764626561656131
      36373239326534336165363564646262656338643664316137373761626330343066363631383832
      32636265643038326532613038636338363062363730343461343362346432306164386231663336
      35323330656132376636326161613733326238613436376461356437666236333630633533356634
      39303364633131643338373435343762376165626539616136653664643966343264616137313130
      39383265623666636433613965663637383539626238346334386264353761363564626235323133
      62623937633830313237623536366236303864366434303338616337616138633831393331656339
      37323136633463343938346639323332653264363138393230623135356462623663316331356666
      39366566633934376163653533353233613364353565313864326637313437383738653365333363
      65633631333634613031373537386236326233633937363333323265376234353932653538396565
      66373939383062646661333362363532346231343132303635336638353966633933393130393233
      61303037303631303364353061323536333061636335396439323631343436353964396533326134
      66613733623735663233653638356633623966653231656164393534306231306133613738363338
      61653364366137663333613731343436613963303665333263313966393838623032396535343365
      62663662616638306330626432313063313634633663346433333765373439653166646465663534
      31616261356462303534663761363938653235366661323730366130366464323732376632633761
      62333035313961323739313366313964613863303530646339313463353532386463353862356439
      63653466323636356631616263333631663639353437343232333963326466303734393637653761
      62336233343937323930363333303939653631656431323339663732663963343737646565373563
      31363630366139316539333666646264633431646530393738393431386334386664633633656536
      62393933303863626532353161653366373933353136646536613634356361653334653564356639
      38316634323032643166333764643436636462383962626137626465633461313362626339303339
      31373562356638616439653438356238363731636338346662643265643432346661303636313863
      35646265366434366366343534333664316332633131646666383461363035663337633232316437
      65623866663039316531623930653431613163643538393638626230666634636238303236633936
      33366539326434613133343337626234653838313666393863623863636139313537653030366463
      34633037343036353932373430366365633530376338386162313166353737313038653637653936
      66316138313461613962376236666330356137373065623439373137363962356132343639616131
      33393139626564353561386263643164356465336664356233636461633237366539643361623231
      66356634343033383534313362643338393430386534366632336336353265623830343162636332
      6162
    aws_region: 'eu-central-1'
    aws_access_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      35366133633063353231396665623265333033383238396435613366643465383062623866643334
      3362333934643764643234643261613263356461356530660a303437643134646531663262313366
      61626639616538373762366162343133613039636537303964363361346261376431356537623533
      6163396233663534610a343763646239363362656666653931393239316437636362613166303438
      36643665313536333834303966663633346262306166643166393339646132343866
    aws_secret_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      63343363653132613038316332313035373536663261663034313130326635636331613061316639
      3430316633333337613737383565333736313762366565330a383735323662383561306664326566
      39333731316362366266656263383861313337313835336234306165386131363964656634313538
      6166313435303339610a326531626163316335343233663664373861616565393231643230383832
      64396132346562366362366230636461393762323635326430383163303030353061313264386530
      6331656134353062373662623331643632383730336634373333
  tasks:
    - name: Write config
      copy:
        content: '{{ conf_py }}'
        dest: 'conf.py'

    - name: Create aws directory
      file:
        path: '.aws'
        state: directory
        mode: '0755'

    - name: Write aws config
      copy:
        content: |
          [default]
          region={{ aws_region }}
        dest: '.aws/config'
        mode: '0600'
        force: no

    - name: Write aws credentials
      copy:
        content: |
          [default]
          aws_access_key_id={{ aws_access_key }}
          aws_secret_access_key={{ aws_secret_key }}
        dest: '.aws/credentials'
        mode: '0600'
        force: no
