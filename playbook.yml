---
- name: Build and push docker image
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    conf_py: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      34383333393662373134373863373338363837653038336165363235306534666130383735376365
      3862663032653734353266626661393166303538663161610a643634313836373032646230386339
      35363735303265363930656439383062313332326431633530356131346637333961303535393735
      3339646466333530350a386666333233353633366235323665313336633064396632303239623265
      38303431653837376439326334373731373538646564346331343138323630313633666464653565
      62306239633833313061313463663366343632313739386631353961393164646162346663373861
      31633462356363633833396234653233383164373931323731353139373065363262303737336461
      65396532333764373966626363343333383666366562303562363133326161346466386564616338
      63323133623539643337653965386430353466636537663165316535613738383939316364643766
      33633337343363346339353766663162613762636130383165653631656266613764396231336162
      34633466343637336638383364363134386164316231616562623334366137653161393262653566
      64643134623437623661653164666161626533363830383665316134346332646666623833353866
      63613439333262653332393938386561643263636162326463666566636365356439336636653266
      33643033643632623335303539363934303339376437663837303966353637366539613938636531
      33333261626130303565373636626137623735623632336265323934323638636461353765646461
      62353230303665306563323532393765636364373630323361303431643836313037623365333665
      64346361646639613266393035666431636665393434313635346130366432636663313962623037
      62636365386133366139313166353732356630393737386665636633346639373739326532353834
      34323739363662373637626135343935313062366631313965343666333332663135346363643034
      62373565353835636432653636376661383464353337373864363361306632666364356261353331
      35653333306333373934353364343265626630626635323761643434623362386237656262613737
      38373134316538386435383166666564303866333063303263366632343165343731346165333834
      33383737626565313262633033653538303962393166373833313234343766396666656461643364
      61663738323865643534346438623061343733373963636231623539343363633732623435353037
      64383739346561343539303264383439343737636361643633343732353536376338356462666531
      61393030313738393263663765343330626330313566303534363533383664643234663532636430
      64613065373863376131663035356330343966333135663339636164643331383663343131336638
      38633937393662306637333534383234303231363334326130373935336135373262343538363539
      37666161653533313961386164343061626164613234353962393731303532323366663864643338
      38653563643030653431343234303261643838303763386137663161386333633531636465613062
      35626364353466643866613662383466366136336364343536326139316139366164303765623233
      36343534393361393763653063666166376662626434623762646164393538613661623736623234
      39616230386162383533666263633261336262353363383439623935346634333739633762316662
      66373435626365383566353662333562326434333631363561383462643366616539656461313761
      62366664343733356362626166633665396330633736613931396635303166653132616230396532
      66663233343739313833643334366366356338656561633165643835316439396565363133376465
      62356663323538656465363233326536336532613639643433343535666538323038316438343334
      32323736383561666437366238313031366362666561656432333431366561333564663231643839
      38366664613835663036613138346564626235383065323733353333353535626564313166373064
      62336138653366336235363732663361656166663863623964643538613366393534373733666566
      34303966336266306331313838643730663733343037353662323434316637323435636365656632
      32396432663639363264346538376231336234343931643939326131623566306638393336643966
      32316162376535313866393863333564636334633330373462383865616233383639393861636363
      30616337316134663034663763633632633238333466623739653561633361396562623534656534
      37323435613233343439313561636266653938393363316362646234616332633139376133343564
      34333465616566303961343839316362643662356365373064623335376665313838653262663662
      66386137633166663661323831653565626631616333326539636630326231653439623930363931
      66633838336563623338303932656438303661613266656165616364333864363736643730393432
      61316631353331383230633136613562656434636632366463666633663036616634643737336261
      33313639666531613065656438326266656563636636646530326539383666323033323030346234
      34616232353833363264653066626632396461383864326661626632663962666330323632653032
      31393062643535373966393166303561303631376534636131613130623737363039633835303164
      34383866356239653630653737653538626437316563663831663031316637306636626430323261
      32656530323537333837343533303063663139353133363466313831623763306432353264656331
      35656462313862623765366635653233376135616237306239383739666462336331613332376262
      38366436653262653761373235313366383762626635636463383662656437306531383339623131
      64313166313832616636343730346262373762336463353735613332663739386433613230376632
      38383761323538323534633533663131623734363037316132626239656531356136643961306439
      64333633343732636536303231366333326165623536323666353461343963653165383532633864
      64643638643530386464343362393962306562326531653361356663346466386533333733623239
      66393965313333393362373538376661653062386638613765303736616661383230623637623261
      65336364313336633537393439303038633031656561323166333034623966303061363265663531
      31656130656462623534326337656135316562653033663462623066373234376634393939303466
      66303934303439623631616335636264326461383333656365396539326233353530323530636534
      37333637373433373333363332623034643265366265623831656438336234363033353632386438
      35373836663138616338303466626130346164396138356533326639653533333132373865323931
      64613530646138326639623031376436333066616234343332373433373762373938623139306136
      36623930663536343164303639306533613866363362613462363138356635303838303031393366
      35346133376362363035313332643533336435303133323263393337636536363634386463646566
      31376232616563333266653039323665373539373634373535656465383433303563363332666131
      36626135313936333835343739643236396663333630353233666265616330366665366333336635
      66623835303135303330623435616333613233633837373264623835653963353939303239353330
      37656566643034386161643234396162333164333366633464396234633964643862616636383466
      61393439613638646163633462663132373063386239316362653365313138636566306535636663
      30333536323764316334663432353435373762306339633861323562653738336534386530653830
      64356662656337313364396561313039633835306632383633356533656137376463333063313764
      36346132313866393230666537643531363739643135646463626461356131646466356335616432
      62396464386133353537366233666238623466313361616161313037306134643235666439656362
      34643132303630623335613763393038373963656230363066393330326265633562303165613331
      65373866643635633032633136353464303532623133623030383035366335623363633266306663
      3166
    aws_region: 'eu-central-1'
    aws_access_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      35366133633063353231396665623265333033383238396435613366643465383062623866643334
      3362333934643764643234643261613263356461356530660a303437643134646531663262313366
      61626639616538373762366162343133613039636537303964363361346261376431356537623533
      6163396233663534610a343763646239363362656666653931393239316437636362613166303438
      36643665313536333834303966663633346262306166643166393339646132343866
    aws_secret_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      63343363653132613038316332313035373536663261663034313130326635636331613061316639
      3430316633333337613737383565333736313762366565330a383735323662383561306664326566
      39333731316362366266656263383861313337313835336234306165386131363964656634313538
      6166313435303339610a326531626163316335343233663664373861616565393231643230383832
      64396132346562366362366230636461393762323635326430383163303030353061313264386530
      6331656134353062373662623331643632383730336634373333
  tasks:
    - name: Write config
      copy:
        content: '{{ conf_py }}'
        dest: 'conf.py'

    - name: Create aws directory
      file:
        path: '.aws'
        state: directory
        mode: '0755'

    - name: Write aws config
      copy:
        content: |
          [default]
          region={{ aws_region }}
        dest: '.aws/config'
        mode: '0600'
        force: no

    - name: Write aws credentials
      copy:
        content: |
          [default]
          aws_access_key_id={{ aws_access_key }}
          aws_secret_access_key={{ aws_secret_key }}
        dest: '.aws/credentials'
        mode: '0600'
        force: no
