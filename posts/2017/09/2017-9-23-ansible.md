# title: Стоит ли ставить на Ansible
# url: ansible
# categories: [Programming, Ubuntu]
# tags: [Ansible, Commands, Python, Shell, SSH]
# time: 2017-09-23 19:28:48.034913+03:00

![left](~logo.png)

Я уже делаю не первый заход на ansible. И вроде не первый playbook написал. Но каждый раз у меня какое-то двоякое ошушение.
Вроде бы поставленную задачу инструмент решает, но в процессе Я выкручиваю себе руки. 
Возможно Я неправильно его готовлю, или возможно это иструмент только для администраторов. 

Но, теже задачи решенные с помошью fabric, показывают что можно и без боли все автоматизировать.    
 

[more]

### Ansible
 
Ansible набрал популярность благодаря простоте, по сравнению с [Chef](https://www.chef.io/chef/), [Puppet](https://puppet.com/) и [SaltStack](https://saltstack.com/). 
Никакого ruby в Chef/Puppet, никакой асинхроншины в Salt, никаких агентов. Только дегларативный YAML и только доступ по SSH.

Я не пробовал Chef и Puppet, но после Salt Ansible воспринимается как глоток свежего воздуха, особенно вторая верисия.

Но первое впечатление обманчиво. Достаточно почитать [Content Organization](http://docs.ansible.com/ansible/latest/playbooks_best_practices.html#content-organization),
[Variable Precedence](http://docs.ansible.com/ansible/latest/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable), 
[Ansible Galaxy](http://docs.ansible.com/ansible/latest/galaxy.html) и
[Playbook Debugger](http://docs.ansible.com/ansible/latest/playbooks_debugger.html)
что бы понять что инструмент совсем не простой.
У него есть разухабистая структура, 2 десятка приоритетов загрузки переменных, и система управления зависимостями, и даже отладчик!

А дальше еще оказывается что YAML только на картинках прикольынй. А в реальности вы можете убить кучу времени, пытаясь понять почему playbook или не запускается или работает не так.
Потому что вы где-то поставили не тот символ, или ошиблись отступом. 

Что-то не особо все это просто.   


### Система управления конфигурациями

Ansible это система управления конфигурациями (Далее SCM). А если верить [wikipedia](https://ru.wikipedia.org/wiki/Конфигурационное_управление),
то это инструмент должен нам ответь как минимум на один очень важный вопрос - Кто-то уже сделал нечто, как нам это воспроизвести?

Прежде чем перейти дальше давайте попытаемся формализовать термины. К сожалению дать четкое определение "конфигурации" нельзя.
Конфиграция может быть как наборм виртуальных машин, так и набором файлов настроек, и даже набором конкретных версий приложений.
Но вот незадача, уведомление на почту - это SCM? А запуск скрипта в Jenkins - это SCM? А deploy артифакта в wildfly - это SCM?
А Ansible все это умеет, и еще многое другое.

Нам ной взгяд, конфигурация - это некоторый элемент системы который имеет как минимум два состояния: сушествует и несушествует, а так же имеет набор дополнительных атрибутов.
Так же этот элемент должен иметь возможность изменять свое стостояния и атрибуты.

Простейший пример - файл. Мы делаем `stat` что бы получить текущее состояние файла. 
Потом командами `rm,touch,chown,chmod` меняем его состояние и атрибуты, до требуемого.

Правда под такое определение не подходят многие модули Ansible. Например уведомления, мы не можем узнать были ли они отправлены при повтороном запуске системы,
и уж темболее не можем откатить их у получателей. 

Как видно Ansible это больше чем SCM. 

И вот тут мы натыкаемся на первую проблему. Какой контекст использования данного иструмента? Где его ограничения?
Оффициальный сайте утверждает что он поможет вам решить любые задачи - [Use cases](https://www.ansible.com/use-cases-overview).
Что естейственно не может быть правдой.


### Программирование

У Ansible декларативный язык разметки. Но, как только вы выходите за рамки поставить пакет и скопировать файл, вы начинаете осозновать что у вас появляются циклы, условия, обработка ошибок, переиспользование кода.
И вы мало по малу начинаете понимать что вы занимаетесь не чем имным как программированием. 
Только у вас в руках не удобные python/ruby. С десятилениями наработок. А наколенчатое решение от админов. 

А дальше еще веселее. Вы упираетесь в модули обертки, например для docker-compose не проброшены какие-то команды или параметры. 
И вам приходится спускаться до обычных вызова shell комманд. 

И вот вы сидите, по локать в "xml программировании", которое дергает обычный shell. И у вас возникает вопрос - а накой черт все это?! 
И например Я, не могу дать ответа на этот вопрос.    


### Переиспользование

Раз уж с созданием playbook все не гладко, может Ansible позволяет переиспользовать чужие? 

Если взгялунть на [Ansible Galaxy](https://galaxy.ansible.com/), то не создается ошушения что там высококачественные роли, которые можно будет спокойно брать и использовать.
Во первых потому что сделать переиспользуемый компонент на чем угодно это сложно. Таких единицы. Во вторых, причина более глубокая.

Нам не нужно переиспользование. Нам нужна автоматизация. Переиспользование подразумевает что у всех все одинаковое. А это не так.
У кого то debian, у кого то centos. Кто то использует LTS пакеты, кто то самые свежие. Кто то тюнит приложения, кому то хватает стандартныйх настроек.
Тут не то что из Galaxy брать роли, тут не факт что из команды рядом получиться что то переиспользовать. 

Поэтому максимум что можно сделать, это взять что то за основу и допилить под себя.

### Docker

Основной враг Ansible это Docker и системы типа Kubernetes. Несмотря на совершенно разное предназначение, они вытестянют все SCM.
Просто потому что не надо учить какой-то новый язык, можно просто написать на bash скрипт. Не надо думать об идемпотентности. 
Не надо думать об удалении старых конфигураций. Не надо ломать голову об установке двух и более java/python/ruby на одну систему.
Я думаю суть ясна. Контейнеры сисльно упростили жизнь. А установку и управлении взяли на себя Kubernetes/Mesos.

Место для SCM осталось совсем немного. Установить базовые пакеты на систему, разложить конфиги/ключи.
И то не факт, потому что это все можно и bash скриптом сделать.


### На что стоит посмотреть

Я уже давно пользуюсь [Fabric](http://www.fabfile.org/). Этот инструмент не навязывает сложных парадигм, а сам базируется на языке python.
Мне он не раз помогал, и я всегда мог решить с ним поставленные задачи.

Но он тоже не без миниусов. У него нет такой богатой библиотеки как в Ansible. Вам придется написать для себя все руками.
Так же стоит упомянуть что Fabric не без архитектурных просчетов. Но это скоро решитсья, так как уже есть [alpha 2ой версии](http://docs.fabfile.org/en/v2/index.html).

Я бы рекомендовал Fabric программистам, что бы не писать на унылом bash. На нем хорошо решаются мелкие задачи автоматизации.
Или же наоборот когда вам надо сделать что-то сложное и специфичное.


### Вывод

      